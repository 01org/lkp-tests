#!/bin/sh

## The packetdrill scripting tool enables quick, precise tests for
## entire TCP/UDP/IPv4/IPv6 network stacks, from the system call
## layer down to the NIC hardware.

cd $BENCHMARK_ROOT/packetdrill/gtests/net || exit

# fix the issue: open tun device: No such file or directory
lsmod | grep -q tun || modprobe tun

for f in $(find packetdrill -name "*.pkt" ! -name "*diag-ipv6*" | sort); do
	echo "Running $f ..."
	ip tcp_metrics flush all > /dev/null 2>&1
	# default tolerance_usecs is 4000 us, allow 10 times(4000 us) on LKP
	opts=$(grep -q -- --tolerance_usecs $f >/dev/null 2>&1 || echo "--tolerance_usecs=40000")
	log_cmd packetdrill/packetdrill $opts $f 2>&1
	return_value=$?
	if [ $return_value -eq 0 ]; then
		echo "$f pass"
	else
		echo "$f failed"
	fi
done

# Delete non-existent files
sed -i 's/\..*tcp_fastopen/sysctl -q net.ipv4.tcp_fastopen/g' \
	tcp/zerocopy/fastopen-server.pkt
sed -i '/sysctl_restore/d' tcp/zerocopy/fastopen-server.pkt

# Use run_all.py to run tcp tests
packetdrill/run_all.py -L -l -v tcp
