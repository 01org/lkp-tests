#!/bin/bash
# - dpdk_commit
# - dpdk_config
# - dpdk_compiler

## DPDK is a set of libraries and drivers for fast packet processing.
## It was designed to run on any processors knowing Intel x86 has
## been the first CPU to be supported. Ports for other CPUs like
## IBM Power 8 are under progress. It runs mostly in Linux userland.
## A FreeBSD port is now available for a subset of DPDK features.

. $LKP_SRC/lib/debug.sh
. $LKP_SRC/lib/mount.sh
. $LKP_SRC/lib/git.sh

merge_configs()
{
	local config_file=$1
	local dot_config=$OBJ_ROOT/.config
	local lines=$(awk -F= '!x[$1]++' $config_file $dot_config)
	echo "$lines" > $dot_config
}

config_file=(
		$LKP_SRC/etc/dpdk-configs/$dpdk_config
		$SRC_ROOT/config/defconfig_$dpdk_config
)
[[ $config_file ]] || die "invalid config file $config_file"

SRC_ROOT=/build/dpdk/src
OBJ_ROOT=/build/dpdk/obj
ARCH=${dpdk_config%%-*}
dpdk_compiler_name=${dpdk_compiler%%-*}

check_mount dpdk-src $SRC_ROOT -t tmpfs
check_mount dpdk-obj $OBJ_ROOT -t tmpfs

git_clone_update git://gitmirror/dpdk $SRC_ROOT || die "failed clone dpdk tree"
git checkout $dpdk_commit || die "failed to checkout commit $dpdk_commit"

export RTE_KERNELDIR=/usr/src/kernels/3.19.5-100.fc20.x86_64/

make O=$OBJ_ROOT config T=$ARCH-native-linuxapp-$dpdk_compiler_name || die "failed to make config"

[[ $config_file =~ "$SRC_ROOT/config" ]] ||
merge_configs $config_file

make O=$OBJ_ROOT DESTDIR=$RESULT_ROOT || die "make failed"
