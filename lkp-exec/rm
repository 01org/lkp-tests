#!/bin/bash

shopt -s nullglob

is_mrt()
{
    local dir=$1
    local -a jobs
    local -a matrix
    matrix=( $dir/matrix.json* )
    [ ${#matrix} -eq 0 ] && return 1
    jobs=( $dir/[0-9]*/job.yaml )
    [ ${#jobs} -ge 1 ]
}

remove_from_mrtts()
{
    local dir=$1
    is_mrt $dir && echo $dir | lkp delete_mrts
}

remove()
{
	local pattern
	local git_tag
	local commit
	local flag_pattern=0
	local cmd
	local path_file
	local dot_temp_file

	for pattern in $patterns
	do
		# expand v3.12 etc. to commit SHA1
		[[ "$pattern" =~ (v[0-9].[0-9]+[_-rc0-9]*) ]] &&
		{
			git_tag=$BASH_REMATCH
			git_tag="${git_tag%/*}"
			commit=$(git rev-list -n1 "$git_tag" 2>/dev/null) &&
			[[ $commit ]] && pattern="${pattern/$git_tag/$commit}"
		}

		if [[ "$flag_pattern" = "0" ]]; then
			cmd="/${pattern//\//\\/}/"
			flag_pattern=1
		else
			cmd="$cmd && /${pattern//\//\\/}/"
		fi
	done

	[[ -d "/lkp/.paths/" ]] || mkdir "/lkp/.paths/" || exit
	dot_temp_file=$(mktemp -p /lkp/.paths/ .tmpXXXXXX)

	for path_file in $(grep -l "$pattern" /lkp/paths/????-??-??-* /lkp/paths/.????-??-??-*)
	do
		awk "BEGIN {modified=0} $cmd {modified=1;next}; {print} END {exit 1-modified}" $path_file > $dot_temp_file &&
		mv -f $dot_temp_file $path_file

	done

	rm -f $dot_temp_file
	cat $temp_file | xargs rm -rf
}

usage()
{
	cat >&2 <<-EOF
Usage: lkp $script_name <patterns>
For example:
lkp $script_name /xfstests/ /lkp-ws02/ /v4.3/
EOF
	exit 1
}

script_name=$(basename $0)
[[ $# = 0 ]] && usage

patterns="$*"

temp_file=$(mktemp)
lkp _rt $patterns > $temp_file

[[ -s "$temp_file" ]] ||
{
	rm -f $temp_file
	echo "Cannot find the match _result_root according to the patterns: $patterns" >&2
	exit 1
}

export GIT_WORK_TREE=${GIT_WORK_TREE:-${LKP_GIT_WORK_TREE:-/c/repo/linux}}
export GIT_DIR=${GIT_DIR:-$GIT_WORK_TREE/.git}

{
echo "Warning:"
echo "\"lkp _rt $patterns\" will be used to search the _resutl_root."
echo "\"lkp rm $patterns\" will remove the following _result_root."
echo

cat $temp_file
} | more

echo -n "!!! Do you really want to do that? [No/yes]: "
read answer
if [[ $answer = "yes" ]]; then

	while read path
	do
		remove_from_mrtts $path
	done < $temp_file

	remove

	echo "Done" >&2
fi

rm $temp_file

