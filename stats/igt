#!/usr/bin/env ruby

LKP_SRC = ENV['LKP_SRC'] || File.dirname(File.dirname(File.realpath($PROGRAM_NAME)))

require "#{LKP_SRC}/lib/statistics"
require "#{LKP_SRC}/lib/string_ext"
require "#{LKP_SRC}/lib/array_ext"
require "#{LKP_SRC}/lib/log"

stats = []

while (line = STDIN.gets)
  line = line.resolve_invalid_bytes

  case line
  when /^(.*): (SUCCESS|FAIL)/
    stats_type = if $2 == 'SUCCESS'
                   'pass'
                 else
                   'fail'
                 end
    stats << $1.tr(' /', '_.') + ".#{stats_type}: 1"
  end
end

stats.each { |stat| puts stat }

# self validation
# rli9 FIXME one possible bad case can be below which is not checked now
#   a.pass: 1
#   a.fail: 1
duplicated_stats = stats.duplicated_elements
unless duplicated_stats.empty?
  log_error "duplicated stats: #{duplicated_stats}"
  exit 1
end
