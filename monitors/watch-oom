#!/bin/sh

kill_one()
{
	kill    $* 2>/dev/null
	sleep 3
	kill -9 $* 2>/dev/null
}

. $LKP_SRC/lib/wait.sh
setup_wait

# dont OOM kill me
echo -1000 > /proc/$$/oom_score_adj

while :
do
	wait_timeout 11

	[ -f "$TMP/job-finished" ] && exit

	grep -s -q -F -e 'Out of memory' -e 'invoked oom-killer: gfp_mask=0x' $RESULT_ROOT/dmesg && {
		touch $TMP/OOM
		pid_tests=$(cat $TMP/pid-tests)
		pid_job=$(cat $TMP/run-job.pid)
		echo "$(date)  Out of memory, stop tests programs" $pid_tests $pid_job
		df -t tmpfs
		kill_one $pid_tests
		kill_one $pid_job
		exit
	}
done
