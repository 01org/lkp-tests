#!/bin/sh
# - events
# - revents
# - time
# - command

perf=/lkp/benchmarks/perf-stat/perf
[ -x "$perf" ] || exit

# perf may consume lots of fd
ulimit -n 102400

if [ -n "$revents" ]; then
	events="$revents"
elif [ -n "$events" ]; then
	events=$(perf-events $events)
	[ -n "$events" ] || exit
else
	events="\
{cycles,instructions,cache-references,cache-misses,branch-instructions,branch-misses},\
{dTLB-loads,dTLB-load-misses},\
{dTLB-stores,dTLB-store-misses},\
{instructions,iTLB-load-misses},\
{node-loads,node-load-misses},\
{node-stores,node-store-misses},\
cpu-clock,task-clock,\
page-faults,context-switches,\
cpu-migrations,\
minor-faults,major-faults"
fi

opt_events="-e $(echo $events | sed 's/ / -e /g')"

[ -n "$command" ] || {
	. $LKP_SRC/lib/wait.sh
	setup_wait

	if [ -n "$time" ]; then
		command="$WAIT_POST_TEST_CMD --timeout $time"
	else
		command="$WAIT_POST_TEST_CMD"
	fi
}

# Disable NMI watchdog to free up one perf counter
test -e  /proc/sys/kernel/nmi_watchdog &&
echo 0 > /proc/sys/kernel/nmi_watchdog

exec $perf stat -a -I 1000 -x' ' $opt_events --log-fd 1 -- $command
